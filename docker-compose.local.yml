# Docker Compose for Local Development
# Usage: docker-compose -f docker-compose.local.yml up -d
#
# Services:
#   - db: PostgreSQL with PostGIS (port 5432)
#   - backend: FastAPI server (port 8000)
#   - frontend: Next.js dev server (port 3000)

services:
  # PostgreSQL with PostGIS extension
  db:
    image: postgis/postgis:15-3.3
    container_name: iran_map_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: iran_map
    ports:
      - "5432:5432"
    volumes:
      - iran_map_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d iran_map"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  # FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: iran_map_backend
    volumes:
      # Mount source code for hot reload
      - ./backend:/app
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://postgres:password@db:5432/iran_map
      CRON_SECRET: dev_secret
      PYTHONUNBUFFERED: "1"
      CHECKWX_API_KEY: "0aaf5dca480d4d13ab21b0be0e7337d4"
      OPENAI_API_KEY: "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"
      OPENAI_MODEL: "gpt-4o-mini" # Can be changed to gpt-4o for better quality
      SUMMARY_INTERVAL_MINUTES: "60" # Generate summary every hour
    depends_on:
      db:
        condition: service_healthy
    # Use reload for development
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped

  # Next.js Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: iran_map_frontend
    volumes:
      # Mount source code for hot reload
      - .:/app
      # Exclude node_modules and .next from mount (use container's versions)
      - /app/node_modules
      - /app/.next
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - WATCHPACK_POLLING=true
    depends_on:
      - backend
    command: npm run dev
    restart: unless-stopped

volumes:
  iran_map_postgres_data:
    name: iran_map_postgres_data
